---
title: "Relatório"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
require(tidyverse)
require(lubridate)
library(caret)
require(zoo)
require(survival)
require(survminer)
```


# Limpeza dos dados. Os pacientes 773, 489 e 212 aparentam apresentar erros no registro da data de evolução.

```{r}
data <- readRDS('dados_att.rds') %>%group_by(pac,exame) %>% 
mutate(DT_EVOL=replace(DT_EVOL, pac==773, '2017-05-26')) %>% 
  mutate(DT_EVOL=replace(DT_EVOL, pac==489, '2017-04-14')) %>% 
  mutate(DT_EVOL=replace(DT_EVOL, pac==212, '2017-02-16'))%>% 
  mutate(DATA_FINAL =difftime(DT_EVOL,DT_IS,units='days') ) %>% 
  mutate(dt_sup=DIAS,dt_inic =lag(DIAS) ) %>% select(-DIAS) %>% 
  mutate(dt_ate_inter =difftime(DT_INTERN,DT_IS,units='days') ) 

```
# Estruturação dos dados

```{r}
dados <- data %>% 
  select(pac,EVOLUCAO,exame,valor,SEXO,DT_NASC,FEBRE:DIARREIA,
         dt_inic,dt_sup,DATA_FINAL,OBITO,dt_ate_inter) %>% 
  mutate(Idade = year(as.Date('2019-12-30'))-year(DT_NASC)) %>% 
  select(-DT_NASC) %>% 
  spread(exame,valor) %>% mutate(TARGET = ifelse(OBITO =='OBITO',1,0)) %>% 
  select(-OBITO,-EVOLUCAO)

####### Seleção de variáveis
data_inic <- dados %>% group_by(pac) %>% filter(is.na(dt_inic)) %>% ungroup(pac) %>% 
  select(Idade,SEXO,TGO,TGP,HEMORRAGIA,DOR_ABDOM,MIALGIA,Leucocitos,
         Bastoes,Creatinina,Linfocitos,Ureia,DATA_FINAL,TARGET)
```

# Estruturação dos dados

```{r}
dados <- data %>% 
  select(pac,EVOLUCAO,exame,valor,SEXO,DT_NASC,FEBRE:DIARREIA,
         dt_inic,dt_sup,DATA_FINAL,OBITO,dt_ate_inter) %>% 
  mutate(Idade = year(as.Date('2019-12-30'))-year(DT_NASC)) %>%
  select(-DT_NASC) %>% 
  spread(exame,valor) %>% mutate(TARGET = ifelse(OBITO =='OBITO',1,0)) %>%
  select(-OBITO,-EVOLUCAO)
```

# Seleção de variáveis

```{r}

data_inic <- dados %>% group_by(pac) %>% filter(is.na(dt_inic)) %>% ungroup(pac) %>% 
  select(Idade,SEXO,TGO,TGP,HEMORRAGIA,DOR_ABDOM,MIALGIA,Leucocitos,
         Bastoes,Creatinina,Linfocitos,Ureia,DATA_FINAL,ICTERICIA,HEMORRAGIA,TARGET)
```

# Correção de dados faltantes

```{r}

dados2 <- dados %>% 
  select(pac,dt_inic,dt_sup,DATA_FINAL,TGO,TGP,TARGET,Idade,Ht,BD,BI,TAP,INR,
         Leucocitos,Bastoes,Creatinina,ICTERICIA,HEMORRAGIA,SEXO,dt_ate_inter
         ,Ureia,GamaGT,Fosfatase_alcal,Plaquetas,SINAL_FAGET) %>% 
  mutate(DATA_FINAL = ifelse(DATA_FINAL<0,max(dt_sup),DATA_FINAL))  


dados_completos <- dados2 %>% group_by(pac)%>% filter(any(DATA_FINAL == dt_sup))

dados_faltantes <- dados2 %>% filter(!(pac %in% (dados_completos$pac %>% unique))) 

dados_faltantes_2 <- dados_faltantes %>% 
  group_by(pac) %>% 
  summarise(dt_inic = max(dt_sup),dt_sup =max(DATA_FINAL)) %>% 
  bind_rows(dados_faltantes,.) %>% arrange(pac) 

dados_final <- bind_rows(dados_completos,dados_faltantes_2)  %>% 
  group_by(pac) %>% mutate(TARGET = ifelse(dt_sup==max(dt_sup),max(TARGET,na.rm = TRUE),0))

dados_input <- dados_final %>% group_by(pac) %>% 
  mutate_at(.vars=vars(DATA_FINAL,TGO,TGP,Ht,Leucocitos,Creatinina,Ht,Idade,SEXO),
            .funs=list(~na.locf(., na.rm = FALSE))) %>% filter(dt_sup !=0) %>% 
  mutate_at(.vars=vars(DATA_FINAL,TGO,TGP,Ht,Leucocitos,Creatinina,Ht,Idade,SEXO),
            .funs=list(~na.locf(., na.rm = FALSE,fromLast=TRUE)))

dados_input <- dados_input%>% 
  group_by(pac) %>% mutate(TARGET = ifelse(dt_sup==max(dt_sup),
      max(TARGET,na.rm = TRUE),0)) %>% ungroup %>%  mutate(dt_inic = ifelse(is.na(dt_inic),0,dt_inic))
         
```



```{r}

```



```{r}
dados_class <- dados_input %>% group_by(pac) %>%
  mutate(TARGET = max(TARGET)) %>% 
  mutate(dt_sup = ifelse(dt_sup <7,'<7','>=7')) %>% 
  mutate(dt_ate_inter=max(dt_ate_inter,na.rm = TRUE)) %>% 
mutate(dt_ate_inter = ifelse(dt_ate_inter <3,'<3','>=3')) 


```

# Mudança dos dados para classificação

```{r}
require(rpart)
require(rattle)

dados_idade <- dados_class %>% select(pac,Idade,TARGET) %>% unique
Arvore_idade = rpart(TARGET~ Idade, data=dados_idade,maxdepth=1)
fancyRpartPlot(Arvore_idade)
```

```{r}
dados_class <- dados_input %>% group_by(pac) %>% 
  mutate(TARGET = max(TARGET)) %>% 
  mutate(dt_sup = ifelse(dt_sup <7,'<7','>=7')) %>% 
  mutate(dt_ate_inter=max(dt_ate_inter,na.rm = TRUE)) %>% 
mutate(dt_ate_inter = ifelse(dt_ate_inter <3,'<3','>=3')) %>% 
  mutate(Idade=ifelse(Idade<40,'<40','>=40'))


```

Nessa estrutura de dados estou considerando cada observação de um invíduo como uma amostra do fenônemo.
Para o indivíduo que sofreu óbito considerei que houve óbito em todos os dias de doença, além disso, 
para a regressão logística categorizei o tempo de doença (dt_sup) em primeira semana de doença ou não.

Esse é um ajuste preliminar para ilustras as técnicas e suas interpretações, a inclusão de mais variáveis fica a seu critério.

# Regressão Logística

# Procedimento step começando com uma variável

## Variáveis testadas:

- log10(TGO)
- dt_sup
- Ht
- Creatinina
- ICTERICIA
- HEMORRAGIA
- log10(Leucocitos)
- dt_ate_inter
- BD
- BI
- TAP
- INR
- Plaquetas

# Dados Faltantes

```{r}
na_count <-sapply(dados_class %>% ungroup %>% 
    select(-c(pac,dt_inic,dt_sup,DATA_FINAL,TARGET)), function(y) sum(length(which(is.na(y)))))
na_count <- data.frame(Faltantes = na_count)
na_count 
```




Preciso lidar esses valores faltantes, não é um procedimento trivial.

```{r}
ajuste_logistica <- step(glm(TARGET ~ log10(TGO)+dt_sup+Ht+Creatinina+ICTERICIA+
  HEMORRAGIA+log10(Leucocitos)+dt_ate_inter+BD+BI+TAP+INR+Plaquetas,
  data=dados_class, family=binomial(link='logit')),direction='both')

```

# Utilizando as variáveis selecionadas no procedimento step, o melhor modelo é, pelo critério do AIC:

```{r}
ajuste_logistica <- glm(TARGET~ dt_sup + Ht + Creatinina +  Idade+dt_ate_inter + BD + 
    TAP + INR + Ureia+ Plaquetas+Idade,
    data=dados_class, family=binomial(link='logit'))



summary(ajuste_logistica)


```


# Interpretação das variávies

Estimativas Negativas indicam diminuição na chance de óbito e estiamtivas prositivas indicam aumento.

- O indivíduo estar a partir do oitavo dia de doença aumenta a razão de chances de cura em exp(3.022)=20.53232 vezes. 
- O aumento de uma unidade de HT aumenta a razão de chances de cura em exp(-0.1169)=0.89 vezes. 
- A presença do sintoma de hemorragia aumenta a razão de chances de óbito em exp(1.160)=3.2 vezes.
- O indivíduo ser internado após apenas após o terceiro dia de manifestação dos sintomas aumenta a razão de chances de óbito em 
exp(9.670e-01) = 2.63


# Árvore de Decisão

```{r}
require(rpart)
require(rattle)

Arvore = rpart(TARGET~ dt_sup + Ht + Creatinina +  Idade+dt_ate_inter + BD + 
    TAP + INR + Ureia+ Plaquetas+Idade, data=dados_class,maxdepth=7)
fancyRpartPlot(Arvore)

```



# DESCONSIDERAR

## Tentativas de aplicação de análise de sobrevivência  


<!-- ```{r} -->
<!-- ########## Ajuste do modelo de regressão de cox considerando algumas variáveis -->
<!-- require(icenReg) -->
<!-- dados_intervalares <- dados_input %>% mutate(dt_sup = ifelse(dt_sup == DATA_FINAL,NA,dt_sup)) -->
<!-- surv_obj <- Surv(dados_intervalares$dt_inic,dados_intervalares$dt_sup,type='interval2') -->

<!-- fit_weibull = ic_sp(surv_obj ~ Ht+log(TGP)+log(Leucocitos), data = dados_intervalares) -->

<!-- ir_clustBoot(fit_weibull, ID = dados_input$pac, bs_samples = 100) -->
<!-- fit_weibull -->
<!-- plot(fit_weibull, lgdLocation = "topright") -->

<!-- ``` -->

<!-- ```{r} -->
<!-- require(intercure) -->
<!-- set.seed(2) -->
<!-- cureset <- sim_frailty(100) -->
<!-- dados_teste <- dados_input %>% drop_na() -->
<!-- # allocates the estimated parameters and covariance matrix -->
<!-- output <- inter_frailty(dados_teste,  -->
<!--                         dados_teste$dt_inic, dados_teste$dt_sup, dados_teste$TARGET,  -->
<!--                         c("Ht", "TGP"), c("Ht", "TGP"), -->
<!--                         M = 30, max_n = 30, burn_in = 10) -->

<!-- output -->

<!-- ``` -->


<!-- ```{r} -->
<!-- require(coxinterval) -->
<!-- dados_teste <- dados_intervalares %>% filter(!is.na(TGO)) %>% group_by(pac) %>% sample_n(1) -->
<!-- surv_obj <- Surv(dados_intervalares$dt_inic,dados_intervalares$dt_sup,type='interval2') -->


<!-- fit_1<-coxaalen(surv_obj~Ht,data=dados_teste) -->
<!-- fit_1 -->
<!-- pred1<-predict(fit_1,new.z=c(15),new.x=c(15)) -->
<!-- pred1$Survival -->
<!-- pred1$CureRate -->
<!-- pred2$CureRate -->
<!-- pred3$CureRate -->
<!-- pred4$CureRate -->

<!-- <!-- ``` --> -->


<!-- Testando as algumas variáveis, chegamos a conclusão que o Creatinina, Ht e Leucócitos são significativas a 5%. -->

<!-- A interpretação dos coeficientes é a seguinte: -->

<!-- Para a Creatinina, um aumento de 1 unidade  resulta em um aumento de 1.36 (36%) no risco no óbito. -->

<!-- Para o Ht, um aumento de 1 unidades resulta em um aumento de .83 no risco de óbito (diminuição de 27%). -->

<!-- Para a quantidade de Leucócitos, um aumento de 100 unidade resultado em um aumento de 2.18 (218%) no risco de óbito. -->

<!-- # Análise de diagnóstico -->


<!-- ```{r} -->

<!-- ############### Teste de hipótese da presença de proporcionalidade -->
<!-- ############### H0 é a hipótese onde os dados são proporcionais, neste caso não se rejeita a hipótese -->
<!-- ############### de proporcionalidade para nenhuma covariável -->
<!-- teste_proporcionalidade <- cox.zph(fit) -->
<!-- teste_proporcionalidade -->

<!-- ############### Resíduos e Teste de schoenfeld para analisar a dependência dos coeficientes ao tempo, -->
<!-- ############## Os testes indicam que não existem evidências para rejeitar-mos a hipótese de independência ao tempo. -->
<!-- require(survminer) -->
<!-- ggcoxzph(test.ph) -->


<!-- ############ Resíduo de Martingale, deve ser observado para todas as variáveins individualmente -->
<!-- ggcoxfunctional(surv_obj ~ TGO,data = dados_disc) -->

<!-- ggcoxfunctional(surv_obj ~ TGP,data = dados_disc) -->
<!-- ``` -->


